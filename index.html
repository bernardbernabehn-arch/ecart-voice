<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TDMH | Full Inventory Audit</title>
    <style>
        :root { --hosp-blue: #1a73e8; --hosp-bg: #f8f9fa; --success: #1e8e3e; --danger: #d93025; --accent: #ff9800; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--hosp-bg); margin: 0; overflow: hidden; }
        nav { background: white; border-bottom: 2px solid #ddd; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .voice-monitor { background: white; margin: 10px; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        #current-item { font-size: 22px; font-weight: 800; color: var(--hosp-blue); text-transform: uppercase; }
        #live-transcript { font-size: 16px; color: var(--accent); min-height: 20px; font-style: italic; margin-top: 5px; }
        .list-viewport { height: calc(100vh - 220px); overflow-y: auto; padding: 0 10px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; }
        th { font-size: 10px; text-transform: uppercase; color: #70757a; padding: 5px; }
        td { background: white; padding: 12px 8px; text-align: center; font-size: 13px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        td:first-child { border-left: 1px solid #eee; border-radius: 8px 0 0 8px; text-align: left; width: 45%; }
        td:last-child { border-right: 1px solid #eee; border-radius: 0 8px 8px 0; }
        .row-focus td { background: #e8f0fe !important; border-color: var(--hosp-blue); }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; background: #ddd; }
        .hosp-input { border: 1px solid #dadce0; border-radius: 4px; padding: 4px; text-align: center; width: 40px; font-size: 12px; }
        .fab-group { position: fixed; bottom: 25px; right: 20px; display: flex; flex-direction: column; gap: 12px; }
        .fab { width: 55px; height: 55px; border-radius: 50%; border: none; color: white; box-shadow: 0 8px 15px rgba(0,0,0,0.2); font-size: 22px; cursor: pointer; }
        #mic-btn { background: var(--hosp-blue); }
        #mic-btn.listening { background: var(--danger); animation: pulse 1.5s infinite; }
        #save-btn { background: var(--success); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<nav><div style="font-weight:bold; color:var(--hosp-blue)">TDMH v7</div><div id="audit-progress" style="font-size:11px">READY</div></nav>
<div class="voice-monitor"><div id="current-item">Tap Mic to Start</div><div id="live-transcript">... waiting ...</div></div>
<div class="list-viewport"><table><thead><tr><th>Medicine</th><th>Req.</th><th>Act.</th><th>Exp.</th><th>St</th></tr></thead><tbody id="audit-body"></tbody></table></div>
<div class="fab-group"><button id="save-btn" class="fab" onclick="syncData()">üíæ</button><button id="mic-btn" class="fab" onclick="toggleVoice()">üé§</button></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_8o2FlMzny4XUhwcs-oCI8Wnfsyzs3RvvuiTytO8uVGMmqI2AvS9Sy_PeTZ6JBmZt/exec";
    
    // FULL LIST RESTORED
    const inventory = [
        {n:"Adenosine 6mg", s:1}, {n:"Amiodarone 150mg", s:2}, {n:"Anti-tetanus serum", s:1}, {n:"Aspirin 325mg", s:4}, {n:"Atropine 1mg", s:4}, {n:"Salbutamol Inhaler", s:5},
        {n:"Diazepam 10mg", s:2}, {n:"Midazolam 5mg", s:2}, {n:"Calcium Gluconate", s:2}, {n:"Clopidogrel 75mg", s:4}, {n:"D5W 250ml", s:4}, {n:"D50W vial", s:2},
        {n:"Digoxin 0.5mg", s:2}, {n:"Diphenhydramine", s:2}, {n:"Dobutamine", s:2}, {n:"Dopamine", s:2}, {n:"Epinephrine 1mg", s:20}, {n:"Furosemide 20mg", s:4},
        {n:"Haloperidol", s:1}, {n:"Hydrocortisone", s:2}, {n:"Lidocaine Spray", s:1}, {n:"Lidocaine Sol", s:4}, {n:"Magnesium Sulfate", s:1}, {n:"Mannitol 20%", s:1},
        {n:"Methylprednisolone", s:1}, {n:"Metoclopramide", s:1}, {n:"Morphine (H.A)", s:1}, {n:"Nitroglycerin", s:2}, {n:"Noradrenaline", s:4}, {n:"Paracetamol IV", s:3},
        {n:"Phenobarbital", s:1}, {n:"Phenytoin", s:1}, {n:"Plain LRS 1L", s:1}, {n:"Plain NSS 1L", s:1}, {n:"Potassium Chloride", s:2}, {n:"Sodium Bicarb", s:4},
        {n:"Verapamil 5mg", s:1}, {n:"Vitamin B Complex", s:1}, {n:"Insulin syringe", s:10}, {n:"1cc Syringe", s:10}, {n:"3cc Syringe", s:10}, {n:"5cc Syringe", s:10},
        {n:"10cc Syringe", s:10}, {n:"20cc Syringe", s:5}, {n:"30cc Syringe", s:2}, {n:"50cc Syringe", s:2}, {n:"Airway Adjuncts", s:1}, {n:"Airway Kit", s:1},
        {n:"Alcohol", s:1}, {n:"Aseptic bulb", s:1}, {n:"Calculator", s:1}, {n:"CBG Kit", s:1}, {n:"Cardiac Board", s:1}, {n:"ET Tube 2.5", s:1},
        {n:"ET Tube 3.0", s:1}, {n:"ET Tube 3.5", s:1}, {n:"ET Tube 4.0", s:1}, {n:"ET Tube 4.5", s:1}, {n:"ET Tube 5.0", s:1}, {n:"ET Tube 5.5", s:1},
        {n:"ET Tube 6.0", s:1}, {n:"ET Tube 6.5", s:1}, {n:"ET Tube 7.0", s:1}, {n:"ET Tube 7.5", s:1}, {n:"ET Tube 8.0", s:1}, {n:"ET Tube 8.5", s:1},
        {n:"Foley FR.14", s:1}, {n:"Foley FR.16", s:1}, {n:"Foley FR.18", s:1}, {n:"Urine Bag", s:2}, {n:"Waterproof Apron", s:2}
    ];

    let currentIdx = 0, state = 'none', rec;
    const tbody = document.getElementById('audit-body');

    inventory.forEach((item, i) => {
        const r = document.createElement('tr'); r.id = `row-${i}`;
        r.innerHTML = `<td style="font-weight:600">${item.n}</td><td>${item.s}</td>
        <td><input type="number" id="q-${i}" class="hosp-input" value="${item.s}"></td>
        <td><input type="text" id="e-${i}" class="hosp-input" style="width:65px" placeholder="Date"></td>
        <td id="s-${i}"><span class="dot"></span></td>`;
        tbody.appendChild(r);
    });

    function toggleVoice() {
        if (state !== 'none') { location.reload(); return; }
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) return alert("Use Chrome.");
        rec = new Speech(); rec.continuous = true; rec.interimResults = true;
        rec.onresult = (e) => {
            let tr = e.results[e.results.length-1][0].transcript.trim().toLowerCase();
            document.getElementById('live-transcript').innerText = tr;
            if(e.results[e.results.length-1].isFinal) handle(tr);
        };
        state = 'qty'; document.getElementById('mic-btn').classList.add('listening');
        run(); rec.start();
    }

    function handle(t) {
        if (state === 'qty') {
            const n = t.match(/\d+/);
            if (n) { document.getElementById(`q-${currentIdx}`).value = n[0]; color(currentIdx); state = 'exp'; speak("Expiry?"); }
        } else {
            document.getElementById(`e-${currentIdx}`).value = t; state = 'qty';
            currentIdx++; if (currentIdx < inventory.length) run(); else done();
        }
    }

    function run() {
        const item = inventory[currentIdx];
        document.getElementById('current-item').innerText = item.n;
        document.getElementById('audit-progress').innerText = `${currentIdx + 1} / ${inventory.length}`;
        document.querySelectorAll('tr').forEach(r => r.classList.remove('row-focus'));
        const active = document.getElementById(`row-${currentIdx}`);
        active.classList.add('row-focus'); active.scrollIntoView({ behavior: 'smooth', block: 'center' });
        speak(item.n);
    }

    function color(i) {
        const act = document.getElementById(`q-${i}`).value;
        const c = (act == inventory[i].s) ? '#1e8e3e' : '#d93025';
        document.getElementById(`s-${i}`).innerHTML = `<span class="dot" style="background:${c}"></span>`;
    }

    function speak(t) { window.speechSynthesis.speak(new SpeechSynthesisUtterance(t)); }

    function done() { 
        rec.stop(); state = 'none'; 
        document.getElementById('mic-btn').classList.remove('listening');
        document.getElementById('current-item').innerText = "DONE"; speak("Audit complete."); 
    }

    async function syncData() {
        const btn = document.getElementById('save-btn'); btn.innerText = "‚è≥";
        const payload = inventory.map((it, i) => ({
            name: it.n, stock: it.s, qty: document.getElementById(`q-${i}`).value, exp: document.getElementById(`e-${i}`).value
        }));
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("‚úÖ Synced to Sheet!");
        } catch (e) { alert("‚ùå Error."); }
        btn.innerText = "üíæ";
    }
</script>
</body>
</html>
